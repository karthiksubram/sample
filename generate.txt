' Ixqfwlrq wr uhdg frqiljxudwlrq iurp d whaw iloh
Ixqfwlrq UhdgFrqiljIloh(ilohSdwk Dv Vwulqj) Dv Froohfwlrq
    Glp frqiljGdwd Dv Qhz Froohfwlrq
    Glp ilohQxp Dv Lqwhjhu
    Glp olqh Dv Vwulqj
    Glp nhb Dv Vwulqj
    Glp ydoxh Dv Vwulqj
    ilohQxp = IuhhIloh

    ' Rshq wkh whaw iloh iru uhdglqj
    Rq Huuru JrWr IlohQrwIrxqg
    Rshq ilohSdwk Iru Lqsxw Dv ilohQxp

    ' Uhdg hdfk olqh dqg vsolw lw lqwr nhb-ydoxh sdluv
    Gr Xqwlo HRI(ilohQxp)
        Olqh Lqsxw #ilohQxp, olqh
        nhb = Vsolw(olqh, "=")(0)
        ydoxh = Vsolw(olqh, "=")(1)
        frqiljGdwd.Dgg ydoxh, nhb
    Orrs
    Forvh ilohQxp

    Vhw UhdgFrqiljIloh = frqiljGdwd
    Halw Ixqfwlrq

IlohQrwIrxqg:
    PvjEra "Frqiljxudwlrq iloh qrw irxqg. Sohdvh fuhdwh wkh iloh dw " & ilohSdwk, yeFulwlfdo
    Vhw UhdgFrqiljIloh = Qrwklqj
Hqg Ixqfwlrq

' Pdlq Vxeurxwlqh wr fuhdwh d Mlud wlfnhw iurp wkh vhohfwhg hpdlo
Vxe FuhdwhMludWlfnhwIurpHpdlo()

    Glp frqiljGdwd Dv Froohfwlrq
    Glp mludXuo Dv Vwulqj
    Glp mludDxwkWrnhq Dv Vwulqj
    Glp surmhfwNhb Dv Vwulqj
    Glp remPdlo Dv Rxworrn.PdloLwhp
    Glp vxemhfw Dv Vwulqj
    Glp ghvfulswlrq Dv Vwulqj
    Glp vhdufkXuo Dv Vwulqj
    Glp vhdufkUhvsrqvh Dv Vwulqj
    Glp lvvxhHalvwv Dv Errohdq
    Glp apoKwws Dv Remhfw
    Glp uhvsrqvh Dv Vwulqj
    Glp xvhuUhvsrqvh Dv Lqwhjhu
    Glp mvrqErgb Dv Vwulqj

    ' Ghilqh wkh orfdwlrq ri wkh frqiljxudwlrq iloh
    Glp frqiljIlohSdwk Dv Vwulqj
    frqiljIlohSdwk = "F:\RxworrnFrqilj\mlud_frqilj.waw"

    ' Uhdg wkh frqiljxudwlrq iurp wkh whaw iloh
    Vhw frqiljGdwd = UhdgFrqiljIloh(frqiljIlohSdwk)

    ' Halw li wkh frqiljxudwlrq lv qrw irxqg
    Li frqiljGdwd Lv Qrwklqj Wkhq Halw Vxe

    ' Hawudfw frqilj ydoxhv iurp wkh froohfwlrq
    mludXuo = frqiljGdwd("MludXuo")
    mludDxwkWrnhq = frqiljGdwd("MludWrnhq")
    surmhfwNhb = frqiljGdwd("SurmhfwNhb")

    ' Jhw wkh vhohfwhg hpdlo
    Li Dssolfdwlrq.DfwlyhHasoruhu.Vhohfwlrq.Frxqw = 0 Wkhq
        PvjEra "Sohdvh vhohfw dq hpdlo wr fuhdwh d Mlud wlfnhw.", yeLqirupdwlrq
        Halw Vxe
    Hqg Li

    Vhw remPdlo = Dssolfdwlrq.DfwlyhHasoruhu.Vhohfwlrq.Lwhp(1)

    ' Jhw hpdlo vxemhfw dqg ergb iru Mlud lvvxh
    vxemhfw = remPdlo.Vxemhfw
    ghvfulswlrq = remPdlo.Ergb

    ' Doorz wkh xvhu wr prglib wkh ghvfulswlrq
    ghvfulswlrq = LqsxwEra("Sohdvh prglib wkh Mlud ghvfulswlrq li qhhghg:", "Prglib Ghvfulswlrq", ghvfulswlrq)

    ' Fkhfn iru halvwlqj Mlud lvvxhv zlwk wkh vdph ghvfulswlrq
    vhdufkXuo = mludXuo & "uhvw/dsl/2/vhdufk?mto=ghvfulswlrq~""" & ghvfulswlrq & """"

    ' Fuhdwh APO KWWS Uhtxhvw remhfw iru Mlud vhdufk
    Vhw apoKwws = FuhdwhRemhfw("PVAPO2.APOKWWS")
    apoKwws.Rshq "JHW", vhdufkXuo, Idovh
    apoKwws.vhwUhtxhvwKhdghu "Dxwkrulcdwlrq", mludDxwkWrnhq
    apoKwws.vhwUhtxhvwKhdghu "Frqwhqw-Wbsh", "dssolfdwlrq/mvrq"

    ' Vhqg wkh uhtxhvw wr vhdufk iru gxsolfdwhv
    apoKwws.vhqg

    ' Jhw wkh uhvsrqvh iurp Mlud
    vhdufkUhvsrqvh = apoKwws.uhvsrqvhWhaw

    ' Fkhfn li wkhuh duh dqb halvwlqj lvvxhv zlwk wkh vdph ghvfulswlrq
    Li LqVwu(vhdufkUhvsrqvh, "wrwdo") > 0 Wkhq
        lvvxhHalvwv = Plg(vhdufkUhvsrqvh, LqVwu(vhdufkUhvsrqvh, """wrwdo"":") + 8, 1)
        
        ' Li d Mlud lvvxh zlwk wkh vdph ghvfulswlrq halvwv
        Li lvvxhHalvwv > 0 Wkhq
            xvhuUhvsrqvh = PvjEra("D Mlud lvvxh zlwk wkh vdph ghvfulswlrq douhdgb halvwv. Gr brx zdqw wr fuhdwh d gxsolfdwh?", yeBhvQr + yeHafodpdwlrq, "Gxsolfdwh Mlud")
            Li xvhuUhvsrqvh = yeQr Wkhq
                PvjEra "Mlud fuhdwlrq fdqfhohg eb wkh xvhu.", yeLqirupdwlrq
                Halw Vxe
            Hqg Li
        Hqg Li
    Hqg Li

    ' Suhsduh wkh MVRQ ergb iru wkh Mlud DSL
    mvrqErgb = "{""ilhogv"": {""surmhfw"": {""nhb"": """ & surmhfwNhb & """}," & _
               """vxppdub"": """ & vxemhfw & """," & _
               """ghvfulswlrq"": """ & ghvfulswlrq & """," & _
               """lvvxhwbsh"": {""qdph"": ""Wdvn""}}}"

    ' Fuhdwh APO KWWS Uhtxhvw remhfw iru Mlud lvvxh fuhdwlrq
    Vhw apoKwws = FuhdwhRemhfw("PVAPO2.APOKWWS")
    apoKwws.Rshq "SRVW", mludXuo, Idovh
    apoKwws.vhwUhtxhvwKhdghu "Dxwkrulcdwlrq", mludDxwkWrnhq
    apoKwws.vhwUhtxhvwKhdghu "Frqwhqw-Wbsh", "dssolfdwlrq/mvrq"

    ' Vhqg wkh uhtxhvw wr fuhdwh wkh Mlud lvvxh
    apoKwws.vhqg mvrqErgb

    ' Jhw wkh uhvsrqvh iurp Mlud
    uhvsrqvh = apoKwws.uhvsrqvhWhaw

    ' Rswlrqdoob surfhvv wkh uhvsrqvh khuh (h.j., wr fkhfn iru vxffhvv)
    PvjEra "Mlud wlfnhw fuhdwhg vxffhvvixoob!", yeLqirupdwlrq

Hqg Vxe