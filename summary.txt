<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Autosys Job Summary</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        function toggleDetails(jobId) {
            const el = document.getElementById('details-' + jobId);
            el.classList.toggle('hidden');
        }
        function onFilter() {
            const filter = document.getElementById('filter').value;
            window.location = `/?filter=${encodeURIComponent(filter)}`;
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen p-8">
    <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">
        Autosys Job Summary (Last 10 Days)
    </h1>

    <!-- Filter/Search -->
    <div class="flex justify-between mb-4">
        <input id="filter" type="text" placeholder="Search job name..." value="{{ search }}"
               class="border border-gray-300 rounded-lg p-2 w-1/3 focus:outline-none focus:ring-2 focus:ring-blue-500"/>
        <button onclick="onFilter()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Filter</button>
    </div>

    <!-- Table -->
    <div class="overflow-x-auto shadow-lg rounded-lg bg-white">
        <table class="min-w-full border-collapse">
            <thead class="bg-blue-100 text-gray-700 uppercase text-sm font-semibold">
                <tr>
                    <th class="py-3 px-4 text-left">Job Name</th>
                    <th class="py-3 px-4 text-left">Last Run Date</th>
                    <th class="py-3 px-4 text-left">Last Status</th>
                    <th class="py-3 px-4 text-left">Action</th>
                </tr>
            </thead>
            <tbody>
            {% for job in jobs %}
                <tr class="border-b hover:bg-gray-50 cursor-pointer" onclick="toggleDetails('{{ loop.index }}')">
                    <td class="py-3 px-4 font-medium text-gray-800">{{ job.job_name }}</td>
                    <td class="py-3 px-4">{{ job.latest_date }}</td>
                    <td class="py-3 px-4 {% if job.latest_status == 'Failed' %}text-red-600{% else %}text-green-600{% endif %} font-semibold">
                        {{ job.latest_status }}
                    </td>
                    <td class="py-3 px-4 text-blue-600 underline">Show Runs</td>
                </tr>

                <!-- Collapsible details -->
                <tr id="details-{{ loop.index }}" class="hidden bg-gray-50">
                    <td colspan="4" class="px-6 py-3">
                        <table class="w-full text-sm border border-gray-200 rounded-lg">
                            <thead class="bg-gray-200">
                                <tr>
                                    <th class="py-2 px-3 text-left">Run Date</th>
                                    <th class="py-2 px-3 text-left">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for run in job.runs %}
                                <tr class="{% if run.status == 'Failed' %}bg-red-100{% endif %}">
                                    <td class="py-2 px-3">{{ run.date }}</td>
                                    <td class="py-2 px-3 {% if run.status == 'Failed' %}text-red-600{% else %}text-green-600{% endif %}">{{ run.status }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div class="flex justify-center mt-6 space-x-2">
        {% if page > 1 %}
        <a href="/?page={{ page - 1 }}&filter={{ search }}" class="px-3 py-2 bg-gray-200 rounded hover:bg-gray-300">Previous</a>
        {% endif %}
        <span class="px-3 py-2 bg-blue-600 text-white rounded">Page {{ page }} / {{ total_pages }}</span>
        {% if page < total_pages %}
        <a href="/?page={{ page + 1 }}&filter={{ search }}" class="px-3 py-2 bg-gray-200 rounded hover:bg-gray-300">Next</a>
        {% endif %}
    </div>

    <footer class="text-center mt-6 text-gray-500 text-sm">
        Â© 2025 Autosys Dashboard | Built with FastAPI + Tailwind
    </footer>
</body>
</html>


from fastapi import FastAPI, Request, Query
from fastapi.responses import HTMLResponse
from fastapi.templating import Jinja2Templates
import uvicorn
from collections import defaultdict

app = FastAPI()
templates = Jinja2Templates(directory="templates")

# -----------------------------
# Example raw records (simulate DB query)
# Each record is one run
# -----------------------------
records = [
    {"job_name": "Job_A", "date": "2025-10-30 12:00", "status": "Success"},
    {"job_name": "Job_A", "date": "2025-10-29 18:00", "status": "Failed"},
    {"job_name": "Job_A", "date": "2025-10-28 14:00", "status": "Success"},
    {"job_name": "Job_B", "date": "2025-10-29 09:00", "status": "Failed"},
    {"job_name": "Job_B", "date": "2025-10-28 08:00", "status": "Success"},
    {"job_name": "Job_C", "date": "2025-10-29 21:00", "status": "Success"},
    {"job_name": "Job_C", "date": "2025-10-28 19:00", "status": "Failed"},
    {"job_name": "Job_D", "date": "2025-10-28 20:00", "status": "Failed"},
] * 50  # simulate many jobs

# -----------------------------
# Utility to group runs by job
# -----------------------------
def group_by_job(records):
    grouped = defaultdict(list)
    for r in records:
        grouped[r["job_name"]].append(r)
    jobs = []
    for job, runs in grouped.items():
        runs = sorted(runs, key=lambda x: x["date"], reverse=True)
        latest = runs[0]
        jobs.append({
            "job_name": job,
            "latest_date": latest["date"],
            "latest_status": latest["status"],
            "runs": runs
        })
    return sorted(jobs, key=lambda j: j["job_name"])

@app.get("/", response_class=HTMLResponse)
async def summary(
    request: Request,
    page: int = Query(1, ge=1),
    per_page: int = Query(10, ge=1, le=50),
    search: str = Query("", alias="filter")
):
    grouped_jobs = group_by_job(records)
    filtered = [job for job in grouped_jobs if search.lower() in job["job_name"].lower()]

    total = len(filtered)
    start = (page - 1) * per_page
    end = start + per_page
    paged = filtered[start:end]
    total_pages = (total + per_page - 1) // per_page

    return templates.TemplateResponse(
        "summary.html",
        {
            "request": request,
            "jobs": paged,
            "page": page,
            "total_pages": total_pages,
            "search": search,
        },
    )

if __name__ == "__main__":
    uvicorn.run("summary:app", host="127.0.0.1", port=9000, reload=True)


